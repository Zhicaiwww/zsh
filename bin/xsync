#!/bin/bash

# Initialize variables
file_list=()
remote_list=()
exculed_option=""
delete_option=""
parallel=1

# Loop through command line arguments
while [[ $# -gt 0 ]]
do
    key="$1"

    case $key in
        -remote)
        remote_list+=("${@:2}")
        shift $#
        ;;

        -d) # Add -d option to enable file deletion
        delete_option="--delete"
        shift
        ;;

        -e)
        exculed_dir=$2
        exculed_option="--exclude=$exculed_dir"
        shift 2
        ;;

        -p) # Add -d option to enable file deletion
        parallel=$2
        shift 2
        ;;

        *)
        file_list+=("$1")
        shift
        ;;
    esac
done

# Check if remote_list is empty (no remote hosts provided)
if [ ${#remote_list[@]} -eq 0 ]; then
    echo "No remote hosts provided!"
    exit 1
fi

# Loop through remote hosts
for host in "${remote_list[@]}" 
do
 (
  echo ====================  $host  ====================
  
  # Loop through files to be transferred
  for file in "${file_list[@]}"
  do
    if [ -e $file ]; then
      pdir=$(cd -P $(dirname $file); pwd)
      fname=$(basename $file)
      ssh $host "mkdir -p $pdir"
      # if parralle is 1 then
      if [ $parallel -eq 1 ]; then
        rsync -av $delete_option $exculed_option $pdir/$fname $host:$pdir
      else
        parallel -j $parallel rsync -av $delete_option $exculed_option {} $host:$pdir/$fname ::: $pdir/$fname/*
      fi
    else
      echo "$file does not exist!"
    fi
  done
 ) &
done
